---
---

{% assign nav = site.data.navigation.navigation %}
{% assign documents = "" | split: "" %}

{%- for c in nav.collections -%}
  {% assign c_docs = site.documents | where: "collection", c %}
  {% assign documents = documents | concat: c_docs %}
{%- endfor -%}

{% assign documents =
  documents
  | where_exp: "page", "page.chapnum != null"
%}

{% if page.subsite %}
  {% assign documents = documents | where: "subsite", page.subsite %}
{% endif %}

{% assign pages =
  documents
  | where_exp: "page", "page.pagenum != null"
  | sort: "pagenum"
%}

{% assign indices =
  documents
  | where_exp: "page", "page.pagenum == null"
  | sort: "chapnum"
%}

<nav class="nav-tree">

{% assign last_collection = nil %}

{% for index in indices %}

  {% if index.collection != last_collection %}
    <div class="nav-collection">
      {{ index.collection | capitalize }}
    </div>
    {% assign last_collection = index.collection %}
  {% endif %}

  {% if nav.collapsible %}
    <details
      class="nav-chapter"
      {% if nav.collapsed != true or page.chapter == index.chapter %}
        open
      {% endif %}
    >
      <summary>
        {{ index.chapter | escape }}
      </summary>
  {% else %}
    <div class="nav-chapter">
      <div class="chapter-title">
        {{ index.chapter | escape }}
      </div>
  {% endif %}

    <ul class="nav-pages">
      {% if nav.show_indices and index.layout == "chapter-index" %}
        <li>
          <a href="{{ index.url | replace: '/index', '' | relative_url }}">
            Index
          </a>
        </li>
      {% endif %}

      {% assign chapter_pages =
        pages
        | where: "chapter", index.chapter
        | where: "collection", index.collection
      %}

      {% for p in chapter_pages %}
        <li{% if p.url == page.url %} class="active"{% endif %}>
          <a href="{{ p.url | relative_url }}">
            {{ p.title | escape }}
          </a>
        </li>
      {% endfor %}
    </ul>

  {% if nav.collapsible %}
    </details>
  {% else %}
    </div>
  {% endif %}

{% endfor %}

</nav>
